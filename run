#!/usr/bin/env bash
set -e -x

JOBS="${JOBS:-12}"
INPUT="${INPUT:-input}"
DATA="${DATA:-data}"
PLOT="${PLOT:-plot}"

prepare_model () {
	exp="$1"
	model="$2"
	type_="$3"
	inpath="$4"
	y1="$5"
	y2="$6"
	years="$(seq $y1 $y2)"
	if [ ! -e "$DATA"/samples/$exp/$model/$y1.nc -o -e "$DATA"/samples/$exp/$model/$y1.nc ]; then
		for y in $years; do
			mkdir -p "$DATA"/samples/$exp/$model/$y
		done
		parallel -j$JOBS bin/prepare_samples cmip "$inpath" none none none none {}-01-01 {}-12-31 "$DATA"/samples/$exp/$model/{} ::: $years
		parallel -j1 bin/merge_samples "$DATA"/samples/$exp/$model/{} "$DATA"/samples/$exp/$model/{}.nc ::: $years
	fi
}

case "$1" in
prepare_ceres_training)
	mkdir -p "$DATA"/samples/ceres_training/{2004,2005,2007} "$DATA"/samples/ceres_training/{2009..2020}
	parallel -j$JOBS bin/prepare_samples ceres "$INPUT"/ceres "$INPUT"/idd/synop "$INPUT"/idd/buoy "$INPUT"/landmask/ne_110m_land.nc both {}-01-01 {}-12-31 "$DATA"/samples/ceres_training/{} ::: 2004 2005 2007 {2009..2020}
	parallel -j1 bin/merge_samples "$DATA"/samples/ceres_training/{} "$DATA"/samples/ceres_training/{}.nc ::: 2004 2005 2007 {2009..2020}
	;;

train_ann)
	mkdir -p "$DATA"/ann
	bin/tf train "$DATA"/samples/ceres_training/ "$DATA"/ann/ceres.h5 "$DATA"/ann/history.nc
	;;

plot_training_history)
	bin/plot_training_history "$DATA"/ann/history.nc "$PLOT"/training_history.pdf
	;;

plot_idd_stations)
	mkdir -p "$DATA"/idd_sample/samples/2010
	mkdir -p "$DATA"/idd_sample/samples_tf/
	mkdir -p "$DATA"/idd_sample/idd
	bin/prepare_samples ceres "$INPUT"/ceres "$INPUT"/idd/synop "$INPUT"/idd/buoy "$INPUT"/landmask/ne_110m_land.nc both 2010-01-01 2010-01-01 "$DATA"/idd_sample/samples/2010 keep_stations: true
	bin/merge_samples "$DATA"/idd_sample/samples/2010 "$DATA"/idd_sample/samples/2010.nc
	cp "$INPUT"/idd/synop/Surface_Synoptic_20100101_0000.nc "$DATA"/idd_sample/idd
	cp "$INPUT"/idd/buoy/Surface_Buoy_20100101_0000.nc "$DATA"/idd_sample/idd
	bin/tf apply "$DATA"/ann/ceres.h5 "$DATA"/idd_sample/samples 2010 2010 "$DATA"/idd_sample/samples_tf
	bin/plot_idd_stations "$DATA"/idd_sample/idd "$DATA/idd_sample/samples/2010/2010-01-01T00:00:00.nc" 0 "$PLOT"/idd_stations.png '2010-01-01'
	;;

plot_sample)
	bin/plot_sample "$DATA/idd_sample/samples/2010/2010-01-01T00:00:00.nc" 0 "$PLOT"/sample.pdf
	;;

prepare_ceres)
	mkdir -p "$DATA"/samples/ceres/{2003..2020}
	parallel -j$JOBS bin/prepare_samples ceres "$INPUT"/ceres none none none none {}-01-01 {}-12-31 "$DATA"/samples/ceres/{} ::: {2003..2020}
	parallel -j1 bin/merge_samples "$DATA"/samples/ceres/{} "$DATA"/samples/ceres/{}.nc ::: {2003..2020}
	;;

prepare_ceres_dense)
	mkdir -p "$DATA"/samples/ceres_dense
	bin/prepare_samples ceres "$INPUT"/ceres none none none none {}-01-01 {}-12-31 "$DATA"/samples/ceres_dense/
	;;

prepare_historical)
	exp=historical
	y1=2003
	y2=2014
	for model in $(cat "$INPUT"/models_$exp); do
		prepare_model $exp $model cmip "$INPUT"/cmip6/$exp/day/by-model/$model $y1 $y2
	done
	prepare_model $exp EC-Earth3P cmip "$INPUT"/cmip6/hist-1950/day/by-model/$model $y1 $y2
	prepare_model $exp MERRA-2 merra2 "$INPUT"/merra-2 $y1 $y2
	prepare_model $exp ERA5 era5 "$INPUT"/era5 $y1 $y2
	prepare_model $exp NorESM2-LM noresm "$INPUT"/noresm2/$exp/day $y1 $y2
	;;

prepare_abrupt-4xCO2)
	exp=abrupt-4xCO2
	y1=1850
	y2=1949
	for model in $(cat "$INPUT"/models_$exp); do
		prepare_model $exp $model cmip "$INPUT"/cmip6/$exp/day/by-model/$model $y1 $y2
	done
	prepare_model $exp NorESM2-LM noresm "$INPUT"/noresm2/$exp/day $y1 $y2
	;;

label_ceres)
	mkdir -p "$DATA"/samples_tf/historical/CERES
	bin/tf apply "$DATA"/ann/ceres.h5 "$DATA"/samples/ceres 2003 2020 "$DATA"/samples_tf/historical/CERES
	;;

label_historical)
	exp=historical
	y1=2003
	y2=2014
	for model in $(cat "$INPUT"/models_$exp); do
		if [ ! -e "$DATA"/samples/$exp/$model -o -e "$DATA"/samples_tf/$exp/$model ]; then
			continue
		fi
		mkdir -p "$DATA"/samples_tf/$exp/$model
		bin/tf apply "$DATA"/ann/ceres.h5 "$DATA"/samples/$exp/$model $y1 $y2 "$DATA"/samples_tf/$exp/$model
	done
	;;

label_abrupt-4xCO2)
	exp=abrupt-4xCO2
	y1=1850
	y2=1949
	y1a=0001
	y2a=0049
	for model in $(cat "$INPUT"/models_$exp); do
		if [ ! -e "$DATA"/samples/$exp/$model -o -e "$DATA"/samples_tf/$exp/$model ]; then
			continue
		fi
		mkdir -p "$DATA"/samples_tf/$exp/$model
		if [ -e "$DATA"/samples/$exp/$model/0001.nc ]; then
			bin/tf apply "$DATA"/ann/ceres.h5 "$DATA"/samples/$exp/$model $y1a $y2a "$DATA"/samples_tf/$exp/$model
		else
			bin/tf apply "$DATA"/ann/ceres.h5 "$DATA"/samples/$exp/$model $y1 $y2 "$DATA"/samples_tf/$exp/$model
		fi
	done
	if [ ! -e "$DATA"/samples_tf/$exp/CERES ]; then
		ln -s ../historical/CERES "$DATA"/samples_tf/$exp/CERES
	fi
	;;

calc_dtau_pct)
	bin/calc_dtau_pct "$DATA"/samples_tf/historical/CERES "$INPUT"/ceres "$DATA"/dtau_pct/dtau_pct.nc
	;;

plot_dtau_pct)
	bin/plot_dtau_pct "$DATA"/dtau_pct/dtau_pct.nc "$PLOT"/dtau_pct.pdf
	;;

calc_geo_cto_historical)
	mkdir -p "$DATA"/geo_cto/historical/all
	if [ ! -e "$DATA"/geo_cto/historical/all/CERES.nc ]; then
		bin/calc_geo_cto "$DATA"/samples_tf/historical/CERES "$INPUT"/tas/historical/CERES.nc "$DATA"/geo_cto/historical/all/CERES.nc
	fi
	for model in $(cat "$INPUT"/models_historical); do
		if [ ! -e "$DATA"/samples_tf/historical/$model -o -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		if [ -e "$INPUT"/tas/historical/$model.nc ]; then
			tas="$INPUT"/tas/historical/$model.nc
		else
			tas="none"
		fi
		bin/calc_geo_cto "$DATA"/samples_tf/historical/$model "$tas" "$DATA"/geo_cto/historical/all/$model.nc
	done
	mkdir -p "$DATA"/geo_cto/historical/part_{1,2}/
	for model in $(cat "$INPUT"/models_historical_part_1); do
		if [ ! -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		cp "$DATA"/geo_cto/historical/all/$model.nc "$DATA"/geo_cto/historical/part_1/
	done
	for model in $(cat "$INPUT"/models_historical_part_2); do
		if [ ! -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		cp "$DATA"/geo_cto/historical/all/$model.nc "$DATA"/geo_cto/historical/part_2/
	done
	;;

calc_geo_cto_abrupt-4xCO2)
	mkdir -p "$DATA"/geo_cto/abrupt-4xCO2/all
	for model in $(cat "$INPUT"/models_abrupt-4xCO2); do
		if [ ! -e "$DATA"/samples_tf/historical/$model -o -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		bin/calc_geo_cto "$DATA"/samples_tf/abrupt-4xCO2/$model "$INPUT"/tas/abrupt-4xCO2/$model.nc "$DATA"/geo_cto/abrupt-4xCO2/all/$model.nc
	done
	mkdir -p "$DATA"/geo_cto/abrupt-4xCO2/part_{1,2}/
	for model in $(cat "$INPUT"/models_abrupt-4xCO2_part_1); do
		if [ ! -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		cp "$DATA"/geo_cto/abrupt-4xCO2/all/$model.nc "$DATA"/geo_cto/abrupt-4xCO2/part_1/
	done
	for model in $(cat "$INPUT"/models_abrupt-4xCO2_part_2); do
		if [ ! -e "$DATA"/geo_cto/historical/all/$model.nc ]; then
			continue
		fi
		cp "$DATA"/geo_cto/abrupt-4xCO2/all/$model.nc "$DATA"/geo_cto/abrupt-4xCO2/part_2/
	done
	;;

calc_geo_cto_ceres_dense)
	mkdir -p "$DATA"/geo_cto/ceres_dense
	parallel -j$JOBS bin/calc_geo_cto {} "$INPUT"/tas/historical/CERES.nc "$DATA"/geo_cto/ceres_dense/[/} :::: $(ls "$DATA"/samples_tf/ceres_dense)
	;;

plot_geo_cto_historical)
	bin/plot_geo_cto 0 true "$DATA"/geo_cto/historical/part_1 "$INPUT"/ecs/ecs.csv "$PLOT"/geo_cto_historical_1.pdf
	bin/plot_geo_cto 0 true "$DATA"/geo_cto/historical/part_2 "$INPUT"/ecs/ecs.csv "$PLOT"/geo_cto_historical_2.pdf
	;;

plot_geo_cto_abrupt-4xCO2)
	bin/plot_geo_cto 0 true "$DATA"/geo_cto/abrupt-4xCO2/part_1 "$INPUT"/ecs/ecs.csv "$PLOT"/geo_cto_abrupt-4xCO2_1.pdf
	bin/plot_geo_cto 0 true "$DATA"/geo_cto/abrupt-4xCO2/part_2 "$INPUT"/ecs/ecs.csv "$PLOT"/geo_cto_abrupt-4xCO2_2.pdf
	;;

plot_cto_rmse_ecs)
	bin/plot_cto_rmse_ecs ecs "$DATA"/geo_cto/historical/all "$INPUT"/ecs/ecs.csv "$PLOT"/cto_rmse_ecs.pdf
	for var in tcr cld; do
		bin/plot_cto_rmse_ecs $var "$DATA"/geo_cto/historical/all "$INPUT"/ecs/ecs.csv "$PLOT"/cto_rmse_${var}.pdf legend: false
	done
	;;

calc_cto_historical)
	mkdir -p "$DATA"/cto/historical
	bin/calc_cto "$DATA"/samples_tf/historical "$INPUT"/tas/historical "$DATA"/cto/historical/cto.nc
	;;

calc_cto_abrupt-4xCO2)
	mkdir -p "$DATA"/cto/abrupt-4xCO2
	bin/calc_cto "$DATA"/samples_tf/abrupt-4xCO2 "$INPUT"/tas/abrupt-4xCO2 "$DATA"/cto/abrupt-4xCO2/cto.nc
	;;

plot_cto_historical)
	bin/plot_cto ecs 0 relative false "$DATA"/cto/historical/cto.nc "$INPUT"/ecs/ecs.csv "$PLOT"/cto_historical.pdf 'CMIP6 historical (2003-2014) and reanalyses (2003-2020) relative to CERES (2003-2020)'
	;;

plot_cto_abrupt-4xCO2)
	bin/plot_cto ecs 1-tas absolute false "$DATA"/cto/abrupt-4xCO2/cto.nc "$INPUT"/ecs/ecs.csv "$PLOT"/cto_abrupt-4xCO2.pdf 'CMIP abrupt-4xCO2 (1850-1949) and CERES (2003-2020)' legend: false
	;;

calc_cto_ecs)
	bin/calc_cto_ecs "$DATA"/cto/abrupt-4xCO2/cto.nc "$INPUT"/ecs/ecs.csv "$DATA"/cto_ecs/cto_ecs.nc
	;;

plot_cto_ecs)
	bin/plot_cto_ecs ecs "$DATA"/cto/abrupt-4xCO2/cto.nc "$DATA"/cto_ecs/cto_ecs.nc "$PLOT"/cto_ecs.pdf
	;;

plot_tf_scheme)
	bin/plot_tf_scheme "$PLOT"/tf_scheme.pdf
	;;

calc_cto_hist)
	mkdir -p "$DATA"/cto_hist
	bin/calc_cto_hist "$DATA"/samples/ceres_training/ "$DATA"/cto_hist/training.nc
	bin/calc_cto_hist "$DATA"/samples_tf/historical/CERES/ "$DATA"/cto_hist/tf.nc
	bin/calc_cto_hist "$DATA"/geo_cto/ceres_dense/ "$DATA"/cto_hist/geo.nc
	;;

plot_cto_hist)
	bin/plot_cto_hist "$DATA"/cto_hist/training.nc "Training samples" "$DATA"/cto_hist/tf.nc "ANN samples" "$DATA"/cto_hist/geo.nc "Geographical distribution" "$PLOT"/cto_hist.pdf
	;;

*)
	printf "%s: Unknown command\n" "$1" >&2
esac
